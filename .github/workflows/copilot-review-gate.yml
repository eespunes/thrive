name: Copilot Review Gate

on:
  pull_request_target:
    types: [opened, reopened, ready_for_review, synchronize]
  pull_request:
    types: [opened, reopened, synchronize, ready_for_review]
  pull_request_review:
    types: [submitted, edited, dismissed]

permissions:
  contents: read
  pull-requests: write

jobs:
  request-copilot-and-assign-owner:
    if: github.event_name == 'pull_request_target' && github.event.pull_request.draft == false
    runs-on: ubuntu-latest
    steps:
      - name: Request Copilot reviewer and assign owner
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const pull_number = context.payload.pull_request.number;
            const ownerUser = "eespunes";

            const reviewerCandidates = [
              "copilot-pull-request-reviewer[bot]",
              "Copilot",
              "github-copilot[bot]"
            ];

            let requested = false;

            for (const reviewer of reviewerCandidates) {
              try {
                await github.rest.pulls.requestReviewers({
                  owner,
                  repo,
                  pull_number,
                  reviewers: [reviewer],
                });
                core.info(`Requested reviewer: ${reviewer}`);
                requested = true;
                break;
              } catch (error) {
                const msg = String(error?.message || "");
                const lower = msg.toLowerCase();

                if (
                  lower.includes("already requested") ||
                  lower.includes("has already been requested") ||
                  lower.includes("review has already been requested")
                ) {
                  core.info(`Reviewer already requested (${reviewer}).`);
                  requested = true;
                  break;
                }

                if (msg.includes("Reviews may only be requested from collaborators")) {
                  core.info(`Skipping ${reviewer}: ${msg}`);
                  continue;
                }

                core.warning(`Could not request ${reviewer}: ${msg}`);
              }
            }

            if (!requested) {
              core.warning(
                "Could not auto-request Copilot reviewer. Check repo Copilot settings and reviewer availability.",
              );
            }

            try {
              await github.rest.issues.addAssignees({
                owner,
                repo,
                issue_number: pull_number,
                assignees: [ownerUser],
              });
              core.info(`Assigned ${ownerUser} to PR #${pull_number}`);
            } catch (error) {
              core.warning(`Could not assign ${ownerUser}: ${error.message}`);
            }

  copilot-review-required:
    if: github.event_name != 'pull_request_target' && github.event.pull_request.draft == false
    runs-on: ubuntu-latest
    steps:
      - name: Ensure Copilot reviewed this PR
        env:
          GH_TOKEN: ${{ github.token }}
          REPO: ${{ github.repository }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          set -euo pipefail

          OWNER="${REPO%%/*}"
          NAME="${REPO##*/}"

          reviews_json=$(gh api \
            "repos/${OWNER}/${NAME}/pulls/${PR_NUMBER}/reviews" \
            --jq '.')

          copilot_reviews=$(echo "$reviews_json" | jq '[.[] | select(.user.login == "github-copilot[bot]" or .user.login == "copilot-pull-request-reviewer" or .user.login == "copilot-pull-request-reviewer[bot]")] | length')

          if [ "$copilot_reviews" -ge 1 ]; then
            echo "Copilot review found ($copilot_reviews)."
            exit 0
          fi

          echo "Copilot review is required before merge."
          echo "Request a review from Copilot in the PR reviewers panel."
          exit 1
