name: Copilot Review Gate

on:
  pull_request:
    types: [opened, reopened, synchronize, ready_for_review]
  pull_request_review:
    types: [submitted, edited, dismissed]

permissions:
  contents: read
  pull-requests: read

jobs:
  copilot-review-required:
    if: github.event.pull_request.draft == false
    runs-on: ubuntu-latest
    steps:
      - name: Ensure Copilot reviewed this PR
        env:
          GH_TOKEN: ${{ github.token }}
          REPO: ${{ github.repository }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          set -euo pipefail

          OWNER="${REPO%%/*}"
          NAME="${REPO##*/}"

          reviews_json=$(gh api \
            "repos/${OWNER}/${NAME}/pulls/${PR_NUMBER}/reviews" \
            --jq '.')

          copilot_reviews=$(echo "$reviews_json" | jq '[.[] | select(.user.login == "github-copilot[bot]")] | length')

          if [ "$copilot_reviews" -ge 1 ]; then
            echo "Copilot review found ($copilot_reviews)."
            exit 0
          fi

          echo "Copilot review is required before merge."
          echo "Request a review from Copilot in the PR reviewers panel."
          exit 1
