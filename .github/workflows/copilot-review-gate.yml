name: Copilot Review Gate

on:
  # Runs with base-repo token to request reviewers safely (no checkout of PR code).
  pull_request_target:
    types: [opened, reopened, ready_for_review, synchronize]
  pull_request:
    types: [opened, reopened, synchronize, ready_for_review]
  pull_request_review:
    types: [submitted, edited, dismissed]

permissions:
  contents: read
  pull-requests: read

jobs:
  request-copilot-and-assign-owner:
    if: github.event_name == 'pull_request_target' && github.event.pull_request.draft == false
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Request Copilot reviewer and assign owner
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const pull_number = context.payload.pull_request.number;
            const ownerUser = "eespunes";

            const reviewerCandidates = [
              "copilot-pull-request-reviewer[bot]",
              "Copilot",
              "github-copilot[bot]"
            ];

            let requested = false;

            for (const reviewer of reviewerCandidates) {
              try {
                await github.rest.pulls.requestReviewers({
                  owner,
                  repo,
                  pull_number,
                  reviewers: [reviewer],
                });
                core.info(`Requested reviewer: ${reviewer}`);
                requested = true;
                break;
              } catch (error) {
                const msg = String(error?.message || "");
                const lower = msg.toLowerCase();

                if (
                  lower.includes("already requested") ||
                  lower.includes("has already been requested") ||
                  lower.includes("review has already been requested")
                ) {
                  core.info(`Reviewer already requested (${reviewer}).`);
                  requested = true;
                  break;
                }

                if (msg.includes("Reviews may only be requested from collaborators")) {
                  core.info(`Skipping ${reviewer}: ${msg}`);
                  continue;
                }

                core.warning(`Could not request ${reviewer}: ${msg}`);
              }
            }

            if (!requested) {
              core.warning(
                "Could not auto-request Copilot reviewer. Check repo Copilot settings and reviewer availability.",
              );
            }

            try {
              await github.rest.issues.addAssignees({
                owner,
                repo,
                issue_number: pull_number,
                assignees: [ownerUser],
              });
              core.info(`Assigned ${ownerUser} to PR #${pull_number}`);
            } catch (error) {
              core.warning(`Could not assign ${ownerUser}: ${error.message}`);
            }

  copilot-review-required:
    if: github.event_name != 'pull_request_target' && github.event.pull_request.draft == false
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
    steps:
      - name: Monitor Copilot review status for current head
        env:
          GH_TOKEN: ${{ github.token }}
          REPO: ${{ github.repository }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          set -euo pipefail

          OWNER="${REPO%%/*}"
          NAME="${REPO##*/}"
          head_sha=$(gh api "repos/${OWNER}/${NAME}/pulls/${PR_NUMBER}" --jq '.head.sha')

          reviews_json=$(gh api \
            "repos/${OWNER}/${NAME}/pulls/${PR_NUMBER}/reviews" \
            --jq '.')

          copilot_reviews_on_head=$(echo "$reviews_json" | jq --arg head "$head_sha" '[.[] | select((.user.login == "github-copilot[bot]" or .user.login == "copilot-pull-request-reviewer" or .user.login == "copilot-pull-request-reviewer[bot]" or .user.login == "Copilot") and .commit_id == $head)] | length')

          if [ "$copilot_reviews_on_head" -lt 1 ]; then
            echo "Copilot review pending for current head: ${head_sha}"
            echo "Blocking merge until Copilot submits a review for this head SHA."
            exit 1
          fi

          threads_json=$(gh api graphql -f query='
            query($owner: String!, $repo: String!, $pr: Int!) {
              repository(owner: $owner, name: $repo) {
                pullRequest(number: $pr) {
                  reviewThreads(first: 100) {
                    nodes {
                      isResolved
                      comments(first: 20) {
                        nodes {
                          author {
                            login
                          }
                        }
                      }
                    }
                  }
                }
              }
            }' -F owner="$OWNER" -F repo="$NAME" -F pr="$PR_NUMBER")

          unresolved_copilot_threads=$(echo "$threads_json" | jq '[.data.repository.pullRequest.reviewThreads.nodes[] | select(.isResolved == false) | select([.comments.nodes[].author.login] | any(. == "github-copilot[bot]" or . == "copilot-pull-request-reviewer" or . == "copilot-pull-request-reviewer[bot]" or . == "Copilot"))] | length')

          if [ "$unresolved_copilot_threads" -gt 0 ]; then
            echo "Copilot has ${unresolved_copilot_threads} unresolved review thread(s)."
            exit 1
          fi

          echo "Copilot review is present for head ${head_sha} and has no unresolved threads."
